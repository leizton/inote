# consumer
## zk
connector := Consumer.create(config: ConsumerConfig)
  new ZookeeperConsumerConnector
ZookeeperConsumerConnector.createMessageStreams(
    topicCountMap: Map[String,Int], keyDecoder: Decoder[K], valueDecoder: Decoder[V])
  $.consume()
    $.registerConsumerInZK()  '/consumers/$groupId/ids/$consumerIdString'
    $.reinitializeConsumer()
      $.loadBalancerListener = new ZKRebalancerListener
      $.topicThreadIdAndQueues.put(topicAndConsumerThreadId)
      $.loadBalancerListener.syncedRebalance()  // 同步rebalance
        $.closeFetchers()
        $.updateFetcher()
          $.fetcher.get.startConnections(allPartitionInfos, cluster)  // ConsumerFetcherManager::startConnections
## KafkaStream
KafkaStream -> ConsumerIterator -> ConsumerFetcherThread -> SimpleConsumer

# producer
## SyncProducer

# request
> SyncProducer
  send(request: TopicMetadataRequest)
  send(producerRequest: ProducerRequest)
> ZookeeperConsumerConnector
  offsetsChannel.send(offsetFetchRequest)
  offsetsChannel.send(offsetCommitRequest)
> ConsumerFetcherManager
  ClientUtils.fetchTopicMetadata()
> SimpleConsumer
  fetch(request: FetchRequest)

# KafkaServer
> startup()
  logManager.startup()
  metadataCache = new MetadataCache(config.brokerId)
  socketServer.startup()
  replicaManager.startup()
  checkpointBrokerId()
  kafkaController.startup()
  adminManager = new AdminManager(metadataCache)
  groupCoordinator.startup()
  val fetchManager = new FetchManager
  apis = new KafkaApis(
    socketServer.requestChannel, replicaManager,
    adminManager, groupCoordinator, kafkaController,
    metadataCache, fetchManager
  )
  requestHandlerPool = new KafkaRequestHandlerPool(
    socketServer.requestChannel, apis
  )

# KafkaApis
> handleProduceRequest
  ReplicaManager.appendRecords
    Partition.appendRecordsToLeader
      ReplicaManager.tryCompleteDelayedFetch(key{topic, partitionId})
        DelayedOperation.checkAndComplete(key)
          $.watchersForKey.get(key)
          if wathcer != null
            watcher.tryCompleteWatched()

# ReplicaManager
> becomeLeaderOrFollower
    $.makeFollowers